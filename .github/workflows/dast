name: DAST (OWASP ZAP vs local DVWA)

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap:
    runs-on: ubuntu-latest
    services:
      dvwa:
        image: vulnerables/web-dvwa
        ports:
          - 8080:80
        options: >-
          --health-cmd="curl -sS http://localhost | grep -iq dvwa || exit 1"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - name: Wait for DVWA
        run: |
          for i in {1..60}; do
            if curl -sS http://localhost:8080 | grep -iq dvwa; then
              echo "DVWA is up"; exit 0
            fi
            sleep 2
          done
          echo "DVWA failed to start" && exit 1

      # Baseline (passive) scan: fast & safe
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8080'
          cmd_options: '-a'   # include alpha passive rules
          fail_action: true

      # Optional: Full active scan (more aggressive; longer runtime)
      # - name: ZAP Full Scan
      #   uses: zaproxy/action-full-scan@v0.10.0
      #   with:
      #     target: 'http://localhost:8080'
      #     cmd_options: '-r'
      #     fail_action: true
